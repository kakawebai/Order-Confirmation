document.addEventListener("DOMContentLoaded",()=>{let e=[],t=null,n=null,i="$",o="USD",a="order",l=[],c={number:"",date:"",dueDate:"",fromName:"",fromAddress:"",fromPhone:"",fromTaxId:"",toName:"",toAddress:"",toPhone:"",toTaxId:"",taxRate:0,notes:""};const d={languageSelect:document.getElementById("languageSelector"),customerInput:document.getElementById("customerNameInput"),orderCustomerGroup:document.getElementById("orderCustomerGroup"),customerNameDisplay:document.getElementById("customerNameDisplay"),dateInput:document.getElementById("orderDate"),orderDateGroup:document.getElementById("orderDateGroup"),currencySelect:document.getElementById("currencySelector"),imageFitSelect:document.getElementById("imageFitSelector"),discountInput:document.getElementById("discountInput"),priceSymbol:document.getElementById("priceCurrencySymbol"),imageInput:document.getElementById("productImage"),imagePreviewBox:document.getElementById("imagePreviewBox"),titleInput:document.getElementById("productTitle"),priceInput:document.getElementById("productPrice"),qtyInput:document.getElementById("productQty"),noteInput:document.getElementById("productNote"),previewTitle:document.getElementById("previewTitle"),labelCustomer:document.getElementById("labelCustomer"),labelDate:document.getElementById("labelDate"),labelTotalItems:document.getElementById("labelTotalItems"),labelOriginalPrice:document.getElementById("labelOriginalPrice"),labelDiscount:document.getElementById("labelDiscount"),labelTotalAmount:document.getElementById("labelTotalAmount"),totalCurrencyCode:document.getElementById("totalCurrencyCode"),totalCurrencySymbol:document.getElementById("totalCurrencySymbol"),originalPriceRow:document.getElementById("originalPriceRow"),originalCurrencyCode:document.getElementById("originalCurrencyCode"),originalCurrencySymbol:document.getElementById("originalCurrencySymbol"),originalAmount:document.getElementById("originalAmount"),discountRow:document.getElementById("discountRow"),discountPercent:document.getElementById("discountPercent"),orderEditor:document.getElementById("orderEditor"),invoiceEditor:document.getElementById("invoiceEditor"),invoiceNumberInput:document.getElementById("invoiceNumberInput"),invoiceDateInput:document.getElementById("invoiceDateInput"),invoiceDueDateInput:document.getElementById("invoiceDueDateInput"),invoiceFromNameInput:document.getElementById("invoiceFromNameInput"),invoiceFromAddressInput:document.getElementById("invoiceFromAddressInput"),invoiceFromPhoneInput:document.getElementById("invoiceFromPhoneInput"),invoiceFromTaxIdInput:document.getElementById("invoiceFromTaxIdInput"),invoiceToNameInput:document.getElementById("invoiceToNameInput"),invoiceToAddressInput:document.getElementById("invoiceToAddressInput"),invoiceToPhoneInput:document.getElementById("invoiceToPhoneInput"),invoiceToTaxIdInput:document.getElementById("invoiceToTaxIdInput"),invoiceTaxRateInput:document.getElementById("invoiceTaxRateInput"),invoiceNotesInput:document.getElementById("invoiceNotesInput"),addInvoiceItemBtn:document.getElementById("addInvoiceItemBtn"),invoiceItemsEditor:document.getElementById("invoiceItemsEditor"),invoiceMeta:document.getElementById("invoiceMeta"),invoiceMetaLabelNumber:document.getElementById("invoiceMetaLabelNumber"),invoiceMetaLabelDate:document.getElementById("invoiceMetaLabelDate"),invoiceMetaLabelDue:document.getElementById("invoiceMetaLabelDue"),invoiceNumberDisplay:document.getElementById("invoiceNumberDisplay"),invoiceDateDisplay:document.getElementById("invoiceDateDisplay"),invoiceDueDateDisplay:document.getElementById("invoiceDueDateDisplay"),invoiceParties:document.getElementById("invoiceParties"),invoiceFromTitle:document.getElementById("invoiceFromTitle"),invoiceToTitle:document.getElementById("invoiceToTitle"),invoiceFromNameDisplay:document.getElementById("invoiceFromNameDisplay"),invoiceFromAddressDisplay:document.getElementById("invoiceFromAddressDisplay"),invoiceFromPhoneDisplay:document.getElementById("invoiceFromPhoneDisplay"),invoiceFromTaxIdDisplay:document.getElementById("invoiceFromTaxIdDisplay"),invoiceToNameDisplay:document.getElementById("invoiceToNameDisplay"),invoiceToAddressDisplay:document.getElementById("invoiceToAddressDisplay"),invoiceToPhoneDisplay:document.getElementById("invoiceToPhoneDisplay"),invoiceToTaxIdDisplay:document.getElementById("invoiceToTaxIdDisplay"),invoiceTaxRow:document.getElementById("invoiceTaxRow"),invoiceTaxLabel:document.getElementById("invoiceTaxLabel"),invoiceTaxAmount:document.getElementById("invoiceTaxAmount"),invoiceNotesDisplay:document.getElementById("invoiceNotesDisplay"),addBtn:document.getElementById("addProductBtn"),updateBtn:document.getElementById("updateProductBtn"),cancelBtn:document.getElementById("cancelEditBtn"),clearAllBtn:document.getElementById("clearAllBtn"),saveBtn:document.getElementById("saveBtn"),saveWhatsAppBtn:document.getElementById("saveWhatsAppBtn"),invoiceToggleBtn:document.getElementById("invoiceToggleBtn"),previewModeHeader:document.getElementById("previewModeHeader"),productList:document.getElementById("productList"),previewItems:document.getElementById("previewItems"),currentDate:document.getElementById("currentDate"),totalCount:document.getElementById("totalCount"),totalAmount:document.getElementById("totalAmount"),captureArea:document.getElementById("captureArea")},r={en:{title:"Order Confirmation",customer:"Customer",date:"Date",totalItems:"Total Items:",originalPrice:"Original Price:",discount:"Discount:",totalAmount:"Total Amount:"},"zh-CN":{title:"订单确认",customer:"客户",date:"日期",totalItems:"商品总数:",originalPrice:"原价:",discount:"折扣:",totalAmount:"合计金额:"},"zh-TW":{title:"訂單確認",customer:"客戶",date:"日期",totalItems:"商品總數:",originalPrice:"原價:",discount:"折扣:",totalAmount:"合計金額:"},ar:{title:"تأكيد الطلب",customer:"العميل",date:"التاريخ",totalItems:"إجمالي العناصر:",originalPrice:"السعر الأصلي:",discount:"الخصم:",totalAmount:"المبلغ الإجمالي:"},ja:{title:"注文確認書",customer:"顧客",date:"日付",totalItems:"合計点数:",originalPrice:"元値:",discount:"割引:",totalAmount:"合計金額:"},ko:{title:"주문 확인서",customer:"고객",date:"날짜",totalItems:"총 수량:",originalPrice:"원래 가격:",discount:"할인:",totalAmount:"총 금액:"},ru:{title:"Подтверждение заказа",customer:"Клиент",date:"Дата",totalItems:"Всего товаров:",originalPrice:"Исходная цена:",discount:"Скидка:",totalAmount:"Итоговая сумма:"},fr:{title:"Confirmation de commande",customer:"Client",date:"Date",totalItems:"Articles au total:",originalPrice:"Prix original:",discount:"Remise:",totalAmount:"Montant total:"},de:{title:"Auftragsbestätigung",customer:"Kunde",date:"Datum",totalItems:"Gesamtartikel:",originalPrice:"Originalpreis:",discount:"Rabatt:",totalAmount:"Gesamtbetrag:"},es:{title:"Confirmación de pedido",customer:"Cliente",date:"Fecha",totalItems:"Artículos totales:",originalPrice:"Precio original:",discount:"Descuento:",totalAmount:"Importe total:"},it:{title:"Conferma d'ordine",customer:"Cliente",date:"Data",totalItems:"Articoli totali:",originalPrice:"Prezzo originale:",discount:"Sconto:",totalAmount:"Importo totale:"}},u={en:"Invoice","zh-CN":"发票","zh-TW":"發票",ar:"فاتورة",ja:"請求書",ko:"송장",ru:"Счёт",fr:"Facture",de:"Rechnung",es:"Factura",it:"Fattura"},s={order:{en:"Order Preview","zh-CN":"订单预览","zh-TW":"訂單預覽",ar:"معاينة الطلب",ja:"注文プレビュー",ko:"주문 미리보기",ru:"Предпросмотр заказа",fr:"Aperçu de commande",de:"Bestellvorschau",es:"Vista previa del pedido",it:"Anteprima ordine"},invoice:{en:"Invoice Preview","zh-CN":"发票预览","zh-TW":"發票預覽",ar:"معاينة الفاتورة",ja:"請求書プレビュー",ko:"송장 미리보기",ru:"Предпросмотр счёта",fr:"Aperçu de facture",de:"Rechnungsvorschau",es:"Vista previa de factura",it:"Anteprima fattura"}},m={en:{item:"Item",qty:"Qty",unit:"Unit",amount:"Amount"},"zh-CN":{item:"商品",qty:"数量",unit:"单价",amount:"小计"},"zh-TW":{item:"商品",qty:"數量",unit:"單價",amount:"小計"},ar:{item:"الصنف",qty:"الكمية",unit:"سعر الوحدة",amount:"المبلغ"},ja:{item:"商品",qty:"数量",unit:"単価",amount:"小計"},ko:{item:"상품",qty:"수량",unit:"단가",amount:"소계"},ru:{item:"Товар",qty:"Кол-во",unit:"Цена",amount:"Сумма"},fr:{item:"Article",qty:"Qté",unit:"PU",amount:"Montant"},de:{item:"Artikel",qty:"Menge",unit:"Stückpreis",amount:"Betrag"},es:{item:"Artículo",qty:"Cant.",unit:"Unit.",amount:"Importe"},it:{item:"Articolo",qty:"Qtà",unit:"Unit.",amount:"Importo"}},v={en:{number:"Number",date:"Date",due:"Due",tax:"Tax",subtotal:"Subtotal:",total:"Total:"},"zh-CN":{number:"编号",date:"日期",due:"到期",tax:"税费",subtotal:"小计:",total:"合计:"},"zh-TW":{number:"編號",date:"日期",due:"到期",tax:"稅費",subtotal:"小計:",total:"合計:"},ar:{number:"الرقم",date:"التاريخ",due:"الاستحقاق",tax:"الضريبة",subtotal:"المجموع الفرعي:",total:"الإجمالي:"},ja:{number:"番号",date:"日付",due:"期日",tax:"税額",subtotal:"小計:",total:"合計:"},ko:{number:"번호",date:"날짜",due:"기한",tax:"세금",subtotal:"소계:",total:"합계:"},ru:{number:"Номер",date:"Дата",due:"Срок",tax:"Налог",subtotal:"Промежуточный итог:",total:"Итого:"},fr:{number:"N°",date:"Date",due:"Échéance",tax:"Taxe",subtotal:"Sous-total:",total:"Total:"},de:{number:"Nr.",date:"Datum",due:"Fällig",tax:"Steuer",subtotal:"Zwischensumme:",total:"Gesamt:"},es:{number:"Núm.",date:"Fecha",due:"Vence",tax:"Impuesto",subtotal:"Subtotal:",total:"Total:"},it:{number:"N.",date:"Data",due:"Scadenza",tax:"Imposta",subtotal:"Subtotale:",total:"Totale:"}},p={en:{from:"From",to:"To"},"zh-CN":{from:"开票方",to:"收票方"},"zh-TW":{from:"開票方",to:"收票方"},ar:{from:"من",to:"إلى"},ja:{from:"差出人",to:"宛先"},ko:{from:"보낸 사람",to:"받는 사람"},ru:{from:"От",to:"Кому"},fr:{from:"De",to:"À"},de:{from:"Von",to:"An"},es:{from:"De",to:"Para"},it:{from:"Da",to:"A"}},y=new Date;d.currentDate.textContent=`${y.getFullYear()}-${String(y.getMonth()+1).padStart(2,"0")}-${String(y.getDate()).padStart(2,"0")}`,function(){const e=new Date,t=new Date(e);t.setDate(t.getDate()+30);const n=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;c.date=n(e),c.dueDate=n(t),d.invoiceDateInput&&(d.invoiceDateInput.value=c.date);d.invoiceDueDateInput&&(d.invoiceDueDateInput.value=c.dueDate)}(),d.customerInput.addEventListener("input",()=>{const e=d.customerInput.value.trim();e?(d.customerNameDisplay.textContent=e,d.customerNameDisplay.parentElement.style.visibility="visible"):(d.customerNameDisplay.textContent="",d.customerNameDisplay.parentElement.style.visibility="hidden")}),d.customerNameDisplay.parentElement.style.visibility="hidden",d.dateInput.addEventListener("input",()=>{d.currentDate.textContent=d.dateInput.value}),d.languageSelect.addEventListener("change",x),d.currencySelect.addEventListener("change",f),d.imageFitSelect.addEventListener("change",A),d.discountInput.addEventListener("input",w),d.imageInput.addEventListener("change",function(e){const t=e.target.files[0];if(t){const e=new FileReader;e.onload=function(e){n=e.target.result,B(n)},e.readAsDataURL(t)}}),d.addBtn.addEventListener("click",function(){const t=h();t&&(e.push(t),N(),A(),d.titleInput.focus())}),d.updateBtn.addEventListener("click",function(){if(!t)return;const n=h();if(n){const i=e.findIndex(e=>e.id===t);-1!==i&&(e[i]={...n,id:t},C(),A())}}),d.cancelBtn.addEventListener("click",C),d.clearAllBtn.addEventListener("click",function(){if(0===e.length)return;confirm("确定清空所有商品吗？")&&(e=[],C(),A())}),d.saveBtn.addEventListener("click",L),d.saveWhatsAppBtn.addEventListener("click",()=>L(!0)),d.productList.addEventListener("click",function(i){const o=i.target.closest(".action-btn");if(!o)return;const a=o.dataset.id;o.classList.contains("del-btn")?confirm("确定删除该商品吗？")&&(e=e.filter(e=>e.id!==a),t===a&&C(),A()):o.classList.contains("edit-btn")&&function(i){const o=e.find(e=>e.id===i);if(!o)return;t=i,d.titleInput.value=o.title,d.priceInput.value=o.price,d.qtyInput.value=o.qty,d.noteInput.value=o.note,n=o.image,B(n),d.addBtn.style.display="none",d.updateBtn.style.display="inline-block",d.cancelBtn.style.display="inline-block",document.querySelector(".left-panel").scrollTop=0}(a)}),d.addInvoiceItemBtn&&d.addInvoiceItemBtn.addEventListener("click",function(){l.push({id:`${Date.now()}_${Math.random().toString(16).slice(2)}`,description:"",qty:1,unitPrice:0}),T(),P(),w()}),d.invoiceItemsEditor&&(d.invoiceItemsEditor.addEventListener("input",function(e){const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.closest(".invoice-edit-row");if(!n)return;const o=n.getAttribute("data-id");if(!o)return;const a=t.getAttribute("data-field");if(!a)return;const c=l.findIndex(e=>e.id===o);if(-1===c)return;if("description"===a)l[c].description=t.value;else if("qty"===a){const e=parseInt(t.value,10);isNaN(e)||(l[c].qty=e)}else if("unitPrice"===a){const e=parseFloat(t.value);isNaN(e)||(l[c].unitPrice=e)}const d=n.querySelector('input[data-field="qty"]'),r=n.querySelector('input[data-field="unitPrice"]'),u=d?parseFloat(d.value):Number(l[c].qty)||0,s=r?parseFloat(r.value):Number(l[c].unitPrice)||0,m=(isNaN(u)?0:u)*(isNaN(s)?0:s),v=n.querySelector(".invoice-edit-amount");v&&(v.textContent=`${i}${m.toFixed(2)}`);P(),w()}),d.invoiceItemsEditor.addEventListener("click",function(e){const t=e.target;if(!(t instanceof HTMLElement))return;if("remove"!==t.getAttribute("data-action"))return;const n=t.closest(".invoice-edit-row");if(!n)return;const i=n.getAttribute("data-id");if(!i)return;l=l.filter(e=>e.id!==i),T(),P(),w()})),D(d.invoiceNumberInput,e=>{c.number=e}),D(d.invoiceFromNameInput,e=>{c.fromName=e}),D(d.invoiceFromAddressInput,e=>{c.fromAddress=e}),D(d.invoiceFromPhoneInput,e=>{c.fromPhone=e}),D(d.invoiceFromTaxIdInput,e=>{c.fromTaxId=e}),D(d.invoiceToNameInput,e=>{c.toName=e}),D(d.invoiceToAddressInput,e=>{c.toAddress=e}),D(d.invoiceToPhoneInput,e=>{c.toPhone=e}),D(d.invoiceToTaxIdInput,e=>{c.toTaxId=e}),D(d.invoiceNotesInput,e=>{c.notes=e}),d.invoiceDateInput&&d.invoiceDateInput.addEventListener("input",()=>{c.date=d.invoiceDateInput.value,E()}),d.invoiceDueDateInput&&d.invoiceDueDateInput.addEventListener("input",()=>{c.dueDate=d.invoiceDueDateInput.value,E()}),d.invoiceTaxRateInput&&d.invoiceTaxRateInput.addEventListener("input",()=>{const e=parseFloat(d.invoiceTaxRateInput.value),t=isNaN(e)||e<0?0:Math.min(100,e);c.taxRate=t,w()}),d.invoiceToggleBtn&&d.invoiceToggleBtn.addEventListener("click",()=>{if(a="invoice"===a?"order":"invoice","invoice"===a){if(0===l.length&&e.length>0&&(l=e.map(e=>({id:e.id,description:e.title,qty:e.qty,unitPrice:e.price}))),!c.toName&&d.customerInput?.value?.trim()&&(c.toName=d.customerInput.value.trim(),d.invoiceToNameInput&&(d.invoiceToNameInput.value=c.toName)),!c.date&&d.dateInput?.value?.trim()){const e=d.dateInput.value.trim();/^\d{4}-\d{2}-\d{2}$/.test(e)&&(c.date=e,d.invoiceDateInput&&(d.invoiceDateInput.value=e))}T(),E()}b()}),f(),x(),b();let I=null;function g(e){return String(e).replace(/[&<>"']/g,e=>{switch(e){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return e}})}function x(){const e=d.languageSelect.value,t=r[e]||r.en;d.previewTitle.textContent="invoice"===a?u[e]||u.en:t.title,d.labelCustomer.textContent=t.customer,d.labelDate.textContent=t.date,d.labelTotalItems.textContent=t.totalItems,d.labelOriginalPrice.textContent=t.originalPrice,d.labelDiscount.textContent=t.discount,d.labelTotalAmount.textContent=t.totalAmount,document.documentElement.lang=e,b()}function b(){const e="invoice"===a;if(d.captureArea.classList.toggle("invoice-mode",e),d.orderCustomerGroup&&(d.orderCustomerGroup.style.display=e?"none":"flex"),d.orderDateGroup&&(d.orderDateGroup.style.display=e?"none":"flex"),d.orderEditor&&(d.orderEditor.style.display=e?"none":"block"),d.invoiceEditor&&(d.invoiceEditor.style.display=e?"block":"none"),d.invoiceMeta&&(d.invoiceMeta.style.display=e?"block":"none"),d.invoiceParties&&(d.invoiceParties.style.display=e?"grid":"none"),d.invoiceTaxRow&&(d.invoiceTaxRow.style.display="none"),d.invoiceNotesDisplay&&(d.invoiceNotesDisplay.style.display=e?"block":"none"),d.previewModeHeader){const t=d.languageSelect?.value||"en",n=e?"invoice":"order";d.previewModeHeader.textContent=s[n]?.[t]||s[n]?.en||""}d.invoiceToggleBtn&&(d.invoiceToggleBtn.setAttribute("aria-pressed",e?"true":"false"),d.invoiceToggleBtn.classList.toggle("primary-btn",e),d.invoiceToggleBtn.classList.toggle("secondary-btn",!e));const t=d.languageSelect?.value||"en",n=r[t]||r.en;if(d.previewTitle&&(d.previewTitle.textContent=e?u[t]||u.en:n.title),e){const e=v[t]||v.en,n=p[t]||p.en;d.invoiceMetaLabelNumber&&(d.invoiceMetaLabelNumber.textContent=e.number),d.invoiceMetaLabelDate&&(d.invoiceMetaLabelDate.textContent=e.date),d.invoiceMetaLabelDue&&(d.invoiceMetaLabelDue.textContent=e.due),d.invoiceFromTitle&&(d.invoiceFromTitle.textContent=n.from),d.invoiceToTitle&&(d.invoiceToTitle.textContent=n.to),d.labelOriginalPrice&&(d.labelOriginalPrice.textContent=e.subtotal),d.labelTotalAmount&&(d.labelTotalAmount.textContent=e.total),d.invoiceTaxLabel&&(d.invoiceTaxLabel.textContent=`${e.tax} (${c.taxRate||0}%):`),E(),T()}P(),w()}function D(e,t){e&&e.addEventListener("input",()=>{t(e.value),E()})}function T(){if(!d.invoiceItemsEditor)return;if("invoice"!==a)return;if(0===l.length)return void(d.invoiceItemsEditor.innerHTML='<div class="empty-state" style="margin-top: 10px;">No items added</div>');const e=l.map(e=>{const t=(Number(e.qty)||0)*(Number(e.unitPrice)||0);return`\n                <div class="invoice-edit-row" data-id="${e.id}">\n                    <input class="invoice-edit-desc" type="text" value="${g(e.description)}" data-field="description" placeholder="Description">\n                    <input class="invoice-edit-qty" type="number" value="${g(e.qty)}" data-field="qty" min="1">\n                    <input class="invoice-edit-unit" type="number" value="${g(e.unitPrice)}" data-field="unitPrice" step="0.01" min="0">\n                    <div class="invoice-edit-amount">${i}${t.toFixed(2)}</div>\n                    <button type="button" class="btn text-btn invoice-edit-remove" data-action="remove">×</button>\n                </div>\n            `}).join("");d.invoiceItemsEditor.innerHTML=`\n            <div class="invoice-edit-head">\n                <div>描述</div>\n                <div style="text-align:right;">数量</div>\n                <div style="text-align:right;">单价</div>\n                <div style="text-align:right;">金额</div>\n                <div></div>\n            </div>\n            ${e}\n        `}function E(){if("invoice"===a){if(d.invoiceNumberDisplay&&(d.invoiceNumberDisplay.textContent=c.number||""),d.invoiceDateDisplay&&(d.invoiceDateDisplay.textContent=c.date||""),d.invoiceDueDateDisplay&&(d.invoiceDueDateDisplay.textContent=c.dueDate||""),d.invoiceFromNameDisplay&&(d.invoiceFromNameDisplay.textContent=c.fromName||""),d.invoiceFromAddressDisplay&&(d.invoiceFromAddressDisplay.textContent=c.fromAddress||""),d.invoiceFromPhoneDisplay&&(d.invoiceFromPhoneDisplay.textContent=c.fromPhone?`Tel: ${c.fromPhone}`:""),d.invoiceFromTaxIdDisplay&&(d.invoiceFromTaxIdDisplay.textContent=c.fromTaxId?`Tax: ${c.fromTaxId}`:""),d.invoiceToNameDisplay&&(d.invoiceToNameDisplay.textContent=c.toName||""),d.invoiceToAddressDisplay&&(d.invoiceToAddressDisplay.textContent=c.toAddress||""),d.invoiceToPhoneDisplay&&(d.invoiceToPhoneDisplay.textContent=c.toPhone?`Tel: ${c.toPhone}`:""),d.invoiceToTaxIdDisplay&&(d.invoiceToTaxIdDisplay.textContent=c.toTaxId?`Tax: ${c.toTaxId}`:""),d.invoiceNotesDisplay){const e=(c.notes||"").trim();d.invoiceNotesDisplay.textContent=e,d.invoiceNotesDisplay.style.display=e?"block":"none"}if(d.invoiceTaxLabel){const e=d.languageSelect?.value||"en",t=v[e]||v.en;d.invoiceTaxLabel.textContent=`${t.tax} (${c.taxRate||0}%):`}}}function f(){i=d.currencySelect.value;const e=d.currencySelect.options[d.currencySelect.selectedIndex].text;o=e.split(" ")[0],d.priceSymbol.textContent=i,d.totalCurrencyCode.textContent=o,d.totalCurrencySymbol.textContent=i,d.originalCurrencyCode.textContent=o,d.originalCurrencySymbol.textContent=i,A()}function B(e){d.imagePreviewBox.innerHTML=e?`<img src="${e}" alt="Preview">`:"<span>暂无图片</span>"}function h(){const e=d.titleInput.value.trim(),t=parseFloat(d.priceInput.value),i=parseInt(d.qtyInput.value),o=d.noteInput.value.trim();return e?isNaN(t)||t<0?(alert("请输入有效的单价"),null):isNaN(i)||i<1?(alert("请输入有效的数量"),null):{id:Date.now().toString(),image:n,title:e,price:t,qty:i,note:o}:(alert("请输入商品标题"),null)}function C(){t=null,N(),d.addBtn.style.display="inline-block",d.updateBtn.style.display="none",d.cancelBtn.style.display="none"}function N(){d.titleInput.value="",d.priceInput.value="",d.qtyInput.value="1",d.noteInput.value="",d.imageInput.value="",n=null,B(null)}function A(){d.productList.innerHTML="",e.forEach(e=>{const t=document.createElement("div");t.className="list-item";const n=d.totalCurrencySymbol.textContent,i=g(e.title);t.innerHTML=`\n                <img src="${e.image||"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2RkZCIvPjwvc3ZnPg=="}">\n                <div class="list-item-info">\n                    <div class="list-item-title">${i}</div>\n                    <div class="list-item-desc">${n}${e.price.toFixed(2)} x ${e.qty}</div>\n                </div>\n                <div class="list-actions">\n                    <button class="action-btn edit-btn" data-id="${e.id}">编辑</button>\n                    <button class="action-btn del-btn" data-id="${e.id}">删除</button>\n                </div>\n            `,d.productList.appendChild(t)}),d.clearAllBtn&&(d.clearAllBtn.style.display=e.length>0?"block":"none"),P(),w()}function P(){d.previewItems.innerHTML="";if(0!==("invoice"===a?l:e).length){if("invoice"===a){const e=d.languageSelect?.value||"en",t=m[e]||m.en,n=document.createElement("div");return n.className="invoice-table-head",n.innerHTML=`\n                <div class="c-item">${t.item}</div>\n                <div class="c-qty">${t.qty}</div>\n                <div class="c-unit">${t.unit}</div>\n                <div class="c-amount">${t.amount}</div>\n            `,d.previewItems.appendChild(n),void l.forEach(e=>{const t=e.unitPrice*e.qty,n=document.createElement("div");n.className="invoice-line";const o=g(e.description);n.innerHTML=`\n                    <div class="c-item" title="${o}">${o}</div>\n                    <div class="c-qty">${e.qty}</div>\n                    <div class="c-unit">${i}${e.unitPrice.toFixed(2)}</div>\n                    <div class="c-amount">${i}${t.toFixed(2)}</div>\n                `,d.previewItems.appendChild(n)})}e.forEach(e=>{const t=e.price*e.qty,n=document.createElement("div");n.className="preview-item";const o=g(e.title),a=g(e.note),l=e.image||"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2YwZjBmMCIvPjwvc3ZnPg==",c="contain"===d.imageFitSelect.value?`<img src="${l}" class="preview-img-contain" style="width: 160px; height: auto; object-fit: contain; border-radius: 4px; flex-shrink: 0; display: block; margin-right: 15px;">`:`<div class="preview-img" style="background-image: url('${l}'); background-size: cover; margin-right: 15px;"></div>`;n.innerHTML=`\n                ${c}\n                <div class="preview-details" style="flex: 1; min-width: 0;">\n                    <div>\n                        <div class="preview-title">${o}</div>\n                        ${e.note?`<div class="preview-note">${a}</div>`:""}\n                    </div>\n                    <div class="preview-price-row">\n                        <span class="price">${i}${e.price.toFixed(2)} x ${e.qty}</span>\n                        <span class="subtotal">${i}${t.toFixed(2)}</span>\n                    </div>\n                </div>\n            `,d.previewItems.appendChild(n)})}else d.previewItems.innerHTML='<div class="empty-state">No items added</div>'}function w(){if("invoice"===a){const e=l.reduce((e,t)=>e+(Number(t.qty)||0),0),t=l.reduce((e,t)=>e+(Number(t.unitPrice)||0)*(Number(t.qty)||0),0),n=Number(c.taxRate)||0,o=Math.max(0,Math.min(100,n)),a=t*(o/100),r=t+a;d.totalCount.textContent=e,d.originalAmount.textContent=t.toFixed(2),d.totalAmount.textContent=r.toFixed(2),d.originalPriceRow.style.display="flex",d.discountRow.style.display="none";const u=d.languageSelect?.value||"en",s=v[u]||v.en;d.invoiceTaxLabel&&(d.invoiceTaxLabel.textContent=`${s.tax} (${o}%):`),d.invoiceTaxAmount&&(d.invoiceTaxAmount.textContent=`${i}${a.toFixed(2)}`);const m=o>0&&a>0;return void(d.invoiceTaxRow&&(d.invoiceTaxRow.style.display=m?"flex":"none"))}const t=e.reduce((e,t)=>e+t.qty,0),n=e.reduce((e,t)=>e+t.price*t.qty,0),o=parseFloat(d.discountInput.value),r=isNaN(o)||o<0?0:Math.min(100,o),u=n*(r/100),s=Math.max(0,n-u),m=""!==d.discountInput.value.trim()&&r>0;d.totalCount.textContent=t,d.originalAmount.textContent=n.toFixed(2),d.discountPercent.textContent=`-${r}%`,d.totalAmount.textContent=s.toFixed(2),d.originalPriceRow.style.display=m?"flex":"none",d.discountRow.style.display=m?"flex":"none"}async function L(e=!1){const t=e?d.saveWhatsAppBtn:d.saveBtn,n=t.textContent;let i;t.textContent="生成超清图片中...",t.disabled=!0;try{i=await(window.html2canvas?Promise.resolve(window.html2canvas):I||(I=new Promise((e,t)=>{const n=document.createElement("script");n.src="https://cdn.bootcdn.net/ajax/libs/html2canvas/1.4.1/html2canvas.min.js",n.async=!0,n.onload=()=>e(window.html2canvas),n.onerror=()=>t(new Error("Failed to load html2canvas")),document.head.appendChild(n)}),I))}catch(e){return t.textContent=n,t.disabled=!1,void alert("截图组件加载失败，请重试")}const o=e?5:function(){const e=Math.max(window.devicePixelRatio||1,4);return Math.min(6,e)}(),l=d.captureArea.style.width,r=d.captureArea.style.maxWidth;d.captureArea.style.width="450px",d.captureArea.style.maxWidth="450px",i(d.captureArea,{scale:o,useCORS:!0,backgroundColor:"#ffffff",width:450,windowWidth:450,onclone:e=>{const t=e.getElementById("captureArea");t&&(t.style.width="450px",t.style.maxWidth="450px",t.style.boxShadow="none",t.style.borderRadius="0")}}).then(i=>{d.captureArea.style.width=l,d.captureArea.style.maxWidth=r;const o=document.createElement("a"),u="invoice"===a?(c.toName||"").trim()||"Customer":d.customerInput.value.trim()||"Customer",s="invoice"===a?(c.date||"").trim()||(new Date).toISOString().split("T")[0]:d.dateInput.value.trim()||(new Date).toISOString().split("T")[0],m=e?"_WA":"",v="invoice"===a?"_Invoice":"",p=u.replace(/[\\/:*?"<>|]/g,"_"),y=s.replace(/[\\/:*?"<>|]/g,"_");o.download=`${p}_${y}${v}${m}.png`,o.href=i.toDataURL("image/png"),o.click(),t.textContent=n,t.disabled=!1}).catch(e=>{console.error("Save failed:",e),d.captureArea.style.width=l,d.captureArea.style.maxWidth=r,alert("图片生成失败，请重试"),t.textContent=n,t.disabled=!1})}});