document.addEventListener("DOMContentLoaded",()=>{let t=[],e=null,n=null,i="$",a="USD";const l={languageSelect:document.getElementById("languageSelector"),customerInput:document.getElementById("customerNameInput"),customerNameDisplay:document.getElementById("customerNameDisplay"),dateInput:document.getElementById("orderDate"),currencySelect:document.getElementById("currencySelector"),imageFitSelect:document.getElementById("imageFitSelector"),discountInput:document.getElementById("discountInput"),priceSymbol:document.getElementById("priceCurrencySymbol"),imageInput:document.getElementById("productImage"),imagePreviewBox:document.getElementById("imagePreviewBox"),titleInput:document.getElementById("productTitle"),priceInput:document.getElementById("productPrice"),qtyInput:document.getElementById("productQty"),noteInput:document.getElementById("productNote"),previewTitle:document.getElementById("previewTitle"),labelCustomer:document.getElementById("labelCustomer"),labelDate:document.getElementById("labelDate"),labelTotalItems:document.getElementById("labelTotalItems"),labelOriginalPrice:document.getElementById("labelOriginalPrice"),labelDiscount:document.getElementById("labelDiscount"),labelTotalAmount:document.getElementById("labelTotalAmount"),totalCurrencyCode:document.getElementById("totalCurrencyCode"),totalCurrencySymbol:document.getElementById("totalCurrencySymbol"),originalPriceRow:document.getElementById("originalPriceRow"),originalCurrencyCode:document.getElementById("originalCurrencyCode"),originalCurrencySymbol:document.getElementById("originalCurrencySymbol"),originalAmount:document.getElementById("originalAmount"),discountRow:document.getElementById("discountRow"),discountPercent:document.getElementById("discountPercent"),addBtn:document.getElementById("addProductBtn"),updateBtn:document.getElementById("updateProductBtn"),cancelBtn:document.getElementById("cancelEditBtn"),clearAllBtn:document.getElementById("clearAllBtn"),saveBtn:document.getElementById("saveBtn"),saveWhatsAppBtn:document.getElementById("saveWhatsAppBtn"),productList:document.getElementById("productList"),previewItems:document.getElementById("previewItems"),currentDate:document.getElementById("currentDate"),totalCount:document.getElementById("totalCount"),totalAmount:document.getElementById("totalAmount"),captureArea:document.getElementById("captureArea")},o={en:{title:"Order Confirmation",customer:"Customer",date:"Date",totalItems:"Total Items:",originalPrice:"Original Price:",discount:"Discount:",totalAmount:"Total Amount:"},"zh-CN":{title:"订单确认",customer:"客户",date:"日期",totalItems:"商品总数:",originalPrice:"原价:",discount:"折扣:",totalAmount:"合计金额:"},"zh-TW":{title:"訂單確認",customer:"客戶",date:"日期",totalItems:"商品總數:",originalPrice:"原價:",discount:"折扣:",totalAmount:"合計金額:"},ar:{title:"تأكيد الطلب",customer:"العميل",date:"التاريخ",totalItems:"إجمالي العناصر:",originalPrice:"السعر الأصلي:",discount:"الخصم:",totalAmount:"المبلغ الإجمالي:"},ja:{title:"注文確認書",customer:"顧客",date:"日付",totalItems:"合計点数:",originalPrice:"元値:",discount:"割引:",totalAmount:"合計金額:"},ko:{title:"주문 확인서",customer:"고객",date:"날짜",totalItems:"총 수량:",originalPrice:"원래 가격:",discount:"할인:",totalAmount:"총 금액:"},ru:{title:"Подтверждение заказа",customer:"Клиент",date:"Дата",totalItems:"Всего товаров:",originalPrice:"Исходная цена:",discount:"Скидка:",totalAmount:"Итоговая сумма:"},fr:{title:"Confirmation de commande",customer:"Client",date:"Date",totalItems:"Articles au total:",originalPrice:"Prix original:",discount:"Remise:",totalAmount:"Montant total:"},de:{title:"Auftragsbestätigung",customer:"Kunde",date:"Datum",totalItems:"Gesamtartikel:",originalPrice:"Originalpreis:",discount:"Rabatt:",totalAmount:"Gesamtbetrag:"},es:{title:"Confirmación de pedido",customer:"Cliente",date:"Fecha",totalItems:"Artículos totales:",originalPrice:"Precio original:",discount:"Descuento:",totalAmount:"Importe total:"},it:{title:"Conferma d'ordine",customer:"Cliente",date:"Data",totalItems:"Articoli totali:",originalPrice:"Prezzo originale:",discount:"Sconto:",totalAmount:"Importo totale:"}},c=new Date;l.currentDate.textContent=`${c.getFullYear()}-${String(c.getMonth()+1).padStart(2,"0")}-${String(c.getDate()).padStart(2,"0")}`,l.customerInput.addEventListener("input",()=>{const t=l.customerInput.value.trim();t?(l.customerNameDisplay.textContent=t,l.customerNameDisplay.parentElement.style.visibility="visible"):(l.customerNameDisplay.textContent="",l.customerNameDisplay.parentElement.style.visibility="hidden")}),l.customerNameDisplay.parentElement.style.visibility="hidden",l.dateInput.addEventListener("input",()=>{l.currentDate.textContent=l.dateInput.value}),l.languageSelect.addEventListener("change",u),l.currencySelect.addEventListener("change",s),l.imageFitSelect.addEventListener("change",I),l.discountInput.addEventListener("input",v),l.imageInput.addEventListener("change",function(t){const e=t.target.files[0];if(e){const t=new FileReader;t.onload=function(t){n=t.target.result,m(n)},t.readAsDataURL(e)}}),l.addBtn.addEventListener("click",function(){const e=p();e&&(t.push(e),y(),I(),l.titleInput.focus())}),l.updateBtn.addEventListener("click",function(){if(!e)return;const n=p();if(n){const i=t.findIndex(t=>t.id===e);-1!==i&&(t[i]={...n,id:e},g(),I())}}),l.cancelBtn.addEventListener("click",g),l.clearAllBtn.addEventListener("click",function(){if(0===t.length)return;confirm("确定清空所有商品吗？")&&(t=[],g(),I())}),l.saveBtn.addEventListener("click",C),l.saveWhatsAppBtn.addEventListener("click",()=>C(!0)),l.productList.addEventListener("click",function(i){const a=i.target.closest(".action-btn");if(!a)return;const o=a.dataset.id;a.classList.contains("del-btn")?confirm("确定删除该商品吗？")&&(t=t.filter(t=>t.id!==o),e===o&&g(),I()):a.classList.contains("edit-btn")&&function(i){const a=t.find(t=>t.id===i);if(!a)return;e=i,l.titleInput.value=a.title,l.priceInput.value=a.price,l.qtyInput.value=a.qty,l.noteInput.value=a.note,n=a.image,m(n),l.addBtn.style.display="none",l.updateBtn.style.display="inline-block",l.cancelBtn.style.display="inline-block",document.querySelector(".left-panel").scrollTop=0}(o)}),s(),u();let r=null;function d(t){return String(t).replace(/[&<>"']/g,t=>{switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return t}})}function u(){const t=l.languageSelect.value,e=o[t]||o.en;l.previewTitle.textContent=e.title,l.labelCustomer.textContent=e.customer,l.labelDate.textContent=e.date,l.labelTotalItems.textContent=e.totalItems,l.labelOriginalPrice.textContent=e.originalPrice,l.labelDiscount.textContent=e.discount,l.labelTotalAmount.textContent=e.totalAmount,document.documentElement.lang=t}function s(){i=l.currencySelect.value;const t=l.currencySelect.options[l.currencySelect.selectedIndex].text;a=t.split(" ")[0],l.priceSymbol.textContent=i,l.totalCurrencyCode.textContent=a,l.totalCurrencySymbol.textContent=i,l.originalCurrencyCode.textContent=a,l.originalCurrencySymbol.textContent=i,I()}function m(t){l.imagePreviewBox.innerHTML=t?`<img src="${t}" alt="Preview">`:"<span>暂无图片</span>"}function p(){const t=l.titleInput.value.trim(),e=parseFloat(l.priceInput.value),i=parseInt(l.qtyInput.value),a=l.noteInput.value.trim();return t?isNaN(e)||e<0?(alert("请输入有效的单价"),null):isNaN(i)||i<1?(alert("请输入有效的数量"),null):{id:Date.now().toString(),image:n,title:t,price:e,qty:i,note:a}:(alert("请输入商品标题"),null)}function g(){e=null,y(),l.addBtn.style.display="inline-block",l.updateBtn.style.display="none",l.cancelBtn.style.display="none"}function y(){l.titleInput.value="",l.priceInput.value="",l.qtyInput.value="1",l.noteInput.value="",l.imageInput.value="",n=null,m(null)}function I(){l.productList.innerHTML="",t.forEach(t=>{const e=document.createElement("div");e.className="list-item";const n=l.totalCurrencySymbol.textContent,i=d(t.title);e.innerHTML=`\n                <img src="${t.image||"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2RkZCIvPjwvc3ZnPg=="}">\n                <div class="list-item-info">\n                    <div class="list-item-title">${i}</div>\n                    <div class="list-item-desc">${n}${t.price.toFixed(2)} x ${t.qty}</div>\n                </div>\n                <div class="list-actions">\n                    <button class="action-btn edit-btn" data-id="${t.id}">编辑</button>\n                    <button class="action-btn del-btn" data-id="${t.id}">删除</button>\n                </div>\n            `,l.productList.appendChild(e)}),l.clearAllBtn&&(l.clearAllBtn.style.display=t.length>0?"block":"none"),function(){if(l.previewItems.innerHTML="",0===t.length)return void(l.previewItems.innerHTML='<div class="empty-state">No items added</div>');t.forEach(t=>{const e=t.price*t.qty,n=document.createElement("div");n.className="preview-item";const a=d(t.title),o=d(t.note),c=t.image||"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2YwZjBmMCIvPjwvc3ZnPg==",r="contain"===l.imageFitSelect.value?`<img src="${c}" class="preview-img-contain" style="width: 160px; height: auto; object-fit: contain; border-radius: 4px; flex-shrink: 0; display: block; margin-right: 15px;">`:`<div class="preview-img" style="background-image: url('${c}'); background-size: cover; margin-right: 15px;"></div>`;n.innerHTML=`\n                ${r}\n                <div class="preview-details" style="flex: 1; min-width: 0;">\n                    <div>\n                        <div class="preview-title">${a}</div>\n                        ${t.note?`<div class="preview-note">${o}</div>`:""}\n                    </div>\n                    <div class="preview-price-row">\n                        <span class="price">${i}${t.price.toFixed(2)} x ${t.qty}</span>\n                        <span class="subtotal">${i}${e.toFixed(2)}</span>\n                    </div>\n                </div>\n            `,l.previewItems.appendChild(n)})}(),v()}function v(){const e=t.reduce((t,e)=>t+e.qty,0),n=t.reduce((t,e)=>t+e.price*e.qty,0),i=parseFloat(l.discountInput.value),a=isNaN(i)||i<0?0:Math.min(100,i),o=n*(a/100),c=Math.max(0,n-o),r=""!==l.discountInput.value.trim()&&a>0;l.totalCount.textContent=e,l.originalAmount.textContent=n.toFixed(2),l.discountPercent.textContent=`-${a}%`,l.totalAmount.textContent=c.toFixed(2),l.originalPriceRow.style.display=r?"flex":"none",l.discountRow.style.display=r?"flex":"none"}async function C(t=!1){const e=t?l.saveWhatsAppBtn:l.saveBtn,n=e.textContent;let i;e.textContent="生成超清图片中...",e.disabled=!0;try{i=await(window.html2canvas?Promise.resolve(window.html2canvas):r||(r=new Promise((t,e)=>{const n=document.createElement("script");n.src="https://cdn.bootcdn.net/ajax/libs/html2canvas/1.4.1/html2canvas.min.js",n.async=!0,n.onload=()=>t(window.html2canvas),n.onerror=()=>e(new Error("Failed to load html2canvas")),document.head.appendChild(n)}),r))}catch(t){return e.textContent=n,e.disabled=!1,void alert("截图组件加载失败，请重试")}const a=t?5:function(){const t=Math.max(window.devicePixelRatio||1,4);return Math.min(6,t)}(),o=l.captureArea.style.width,c=l.captureArea.style.maxWidth;l.captureArea.style.width="450px",l.captureArea.style.maxWidth="450px",i(l.captureArea,{scale:a,useCORS:!0,backgroundColor:"#ffffff",width:450,windowWidth:450,onclone:t=>{const e=t.getElementById("captureArea");e&&(e.style.width="450px",e.style.maxWidth="450px",e.style.boxShadow="none",e.style.borderRadius="0")}}).then(i=>{l.captureArea.style.width=o,l.captureArea.style.maxWidth=c;const a=document.createElement("a"),r=l.customerInput.value.trim()||"Customer",d=l.dateInput.value.trim()||(new Date).toISOString().split("T")[0],u=t?"_WA":"",s=r.replace(/[\\/:*?"<>|]/g,"_"),m=d.replace(/[\\/:*?"<>|]/g,"_");a.download=`${s}_${m}${u}.png`,a.href=i.toDataURL("image/png"),a.click(),e.textContent=n,e.disabled=!1}).catch(t=>{console.error("Save failed:",t),l.captureArea.style.width=o,l.captureArea.style.maxWidth=c,alert("图片生成失败，请重试"),e.textContent=n,e.disabled=!1})}});